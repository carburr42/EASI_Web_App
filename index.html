<!DOCTYPE html>
<html lang="en">
<!-- EASI.js REFERENCE -->
<script src="EASI.js"></script>

<head>
  <meta charset="utf-8" />
  <title>EASI Web App</title>

  <style>
    /* Base table look */
    table { border-collapse: collapse; }
    th, td { padding: 6px; border: 1px solid black; }
    .invis { border: none; }

    /* Layer / Task Layout (editor area) */
    .layers-wrap { display: flex; flex-direction: column; gap: 10px; margin-top: 12px; }

    .layer { display: flex; align-items: stretch; gap: 10px; border: 1px solid black; padding: 6px; }

    .layer-title {
      min-width: 180px; display: flex; align-items: center; justify-content: center;
      border: 1px solid black; padding: 6px; font-weight: 600; background: #efefef;
      cursor: move;
      user-select: none; -webkit-user-select: none; /* avoid selecting text for table dragging */
    }

    /* Vertical Task Stack (editor area) */
    .tasks-row { flex: 0 0 auto; display: flex; flex-direction: column; gap: 10px; align-items: stretch; }

    .task-table { display: table; width: auto; table-layout: fixed; }
    .task-table th, .task-table td { padding: 6px; border: 1px solid black; text-align: left; }

    /* Drag-handle for Task Table */
    .drag-handle {
      display: inline-flex; align-items: center; justify-content: center;
      width: 22px; height: 22px; margin-right: 8px;
      border: 1px solid #999; border-radius: 4px; background: #f5f5f5;
      font-size: 14px; line-height: 1; cursor: move;
      user-select: none; -webkit-user-select: none;
    }
    .drag-handle:active { opacity: 0.85; }

    .task-handle { user-select: none; -webkit-user-select: none; }
    .task-header-container { display: flex; align-items: center; gap: 8px; }
    .task-header-right { margin-left: auto; display: flex; align-items: center; gap: 6px; }
    .task-header-right button { padding: 2px 6px; }

    .task-controls { display: flex; flex-direction: column; gap: 6px; align-items: center; justify-content: center; }

    .controls-row { margin-top: 10px; display: flex; gap: 8px; }
    button { cursor: pointer; }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }

    /* Drag + Drop visual*/
    .dragging { opacity: 0.6; }
    .drag-over { outline: 2px dotted #2a6df4; }

    /* Path Selector (read only area) */
    .path-wrap { display: flex; flex-direction: column; gap: 12px; margin-top: 14px; }
    .path-row { display: flex; align-items: center; gap: 8px; }
    .path-layer-heading { font-weight: 600; min-width: 80px; }

    .task-table-ro { display: table; width: auto; table-layout: fixed; margin-top: 6px; }
    .task-table-ro th, .task-table-ro td { padding: 6px; border: 1px solid black; text-align: left; }

    /* Blue highlight for selected tasks (editor area) */
    .path-highlight { outline: 2px solid #2a6df4; background: rgba(42,109,244,0.22); box-shadow: inset 0 0 0 2px rgba(42,109,244,0.15); }
    .path-highlight th, .path-highlight td { background: rgba(42,109,244,0.22); }

    /* Risk highlights (read only area) */
    .task-table-ro.risk-low,  .task-table-ro.risk-low  th, .task-table-ro.risk-low  td { background: rgba(255,235,59,0.35); }
    .task-table-ro.risk-low  { outline: 2px solid rgba(255,235,59,0.9); }
    .task-table-ro.risk-med,  .task-table-ro.risk-med  th, .task-table-ro.risk-med  td { background: rgba(255,152,0,0.35); }
    .task-table-ro.risk-med  { outline: 2px solid rgba(255,152,0,0.9); }
    .task-table-ro.risk-high, .task-table-ro.risk-high th, .task-table-ro.risk-high td { background: rgba(244,67,54,0.35); }
    .task-table-ro.risk-high { outline: 2px solid rgba(244,67,54,0.9); }
  </style>

  <p style="text-align:center; border:none; font-size:25px;">
    Estimate of Adversary Sequence Interruption
  </p>
</head>
<hr><br>
<body>

  <!-- GLOBAL INPUTS -->
  <table>
    <thead>
      <th>P(Transmission):</th>
      <th>P(Assessment):</th>
      <th>Response Mean:</th>
      <th>Force Time (in Seconds) Standard Deviation:</th>
    </thead>
    <tbody id="smallTable">
      <td><input type="number" min="0" max="1" step="0.01" onchange="handleChange()"></td>
      <td><input type="number" min="0" max="1" step="0.01" onchange="handleChange()"></td>
      <td><input type="number" min="0" step="1" onchange="handleChange()"></td>
      <td><input type="number" min="0" step="0.1" onchange="handleChange()"></td>
    </tbody>
  </table>

  <table><tbody><td class="invis"></td></tbody></table>

  <!-- INPUT LAYERS -->
  <div id="layersContainer" class="layers-wrap"></div>

  <div class="controls-row">
    <button id="addLayerBtn" onclick="addLayer()">+ layer</button>
    <button id="removeLayerBtn" onclick="removeLayer()">− layer</button>
  </div>

  <!-- Guard Communication -->
  <table style="margin-top:10px;">
    <thead><th>Probability of Guard Communication:</th></thead>
    <tbody id="guardTable">
      <td><input id="guardCommInput" type="number" min="0" max="1" step="0.01" onchange="handleChange()"></td>
    </tbody>
  </table>

  <!-- PATH SELECT -->
  <br><hr>
  <p style="text-align:center; border:none; font-size:25px;">Select a Path</p>
  <div class="controls-row">
    <button id="useMVPBtn" type="button">use most vulnerable path</button>
    <button id="toggleHLBtn" type="button">toggle highlight</button>
    <button id="clearPathBtn" type="button">clear</button>
  </div>

  <div id="pathBuilderWrap" class="path-wrap"></div>

  <div id="userPathPI" style="margin: 6px 0 12px 0; font-weight:600;">
    Probability of Interruption: full path required
  </div>

  <!-- Hidden MVP/prints (kept for compatibility with EASI.js) -->
  <!-- (Was used for debugging) -->
  <table style="display:none;">
    <tbody>
      <tr><th>Most Vulnerable Path:</th><th id="MVPpath"></th></tr>
      <tr><th>Probability of Interruption:</th><th id="EASIresult"></th></tr>
    </tbody>
  </table>
  <pre id="PathList" style="display:none;"></pre>
  <pre id="MVPList" style="display:none;"></pre>

  <script>
    /* helpers */
    function fmtNum(v){ const n=Number(v); if(!Number.isFinite(n)) return ''; const s=n.toFixed(6); return s.replace(/\.?0+$/,''); }
    function pick(obj, keys, fb=''){ if(!obj) return fb; for(const k of keys){ if(obj[k]!==undefined && obj[k]!==null) return obj[k]; } return fb; }

    /* model */
    const layersContainer=document.getElementById('layersContainer');
    function makeTask(desc=''){ return { desc, pDetection:'', location:'B', mean:'', sdev:'' }; }
    function makeLayer(){ return { tasks:[makeTask()] }; }
    let layers=[];

    function moveItem(arr,from,to){ if(from===to) return; const [x]=arr.splice(from,1); arr.splice(to,0,x); }
    function getDndData(e){ try{ return JSON.parse(e.dataTransfer.getData('application/json')||e.dataTransfer.getData('text/plain')||'{}'); }catch{ return null; } }
    function addDragVisuals(el){
      el.addEventListener('dragenter',e=>{ e.preventDefault(); el.classList.add('drag-over'); });
      el.addEventListener('dragleave',()=>el.classList.remove('drag-over'));
      el.addEventListener('dragend', ()=>el.classList.remove('drag-over'));
      el.addEventListener('drop',   ()=>el.classList.remove('drag-over'));
    }

    /* -------- Rendering main editor -------- */
    function render(){
      layersContainer.innerHTML='';
      layers.forEach((layer,lIdx)=>{
        const layerDiv=document.createElement('div'); layerDiv.className='layer';

        /* LAYER drag handle */
        const title=document.createElement('div'); title.className='layer-title'; title.textContent=`Layer ${lIdx+1}`;
        title.draggable=true;
        title.addEventListener('dragstart',e=>{ e.stopPropagation(); e.dataTransfer.effectAllowed='move';
          e.dataTransfer.setData('application/json',JSON.stringify({type:'layer',from:lIdx})); title.classList.add('dragging'); });
        title.addEventListener('dragend',e=>{ e.stopPropagation(); title.classList.remove('dragging'); });
        title.addEventListener('dragover',e=>{ e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect='move'; });
        title.addEventListener('drop',e=>{ e.preventDefault(); e.stopPropagation();
          const data=getDndData(e); if(data&&data.type==='layer'){ moveItem(layers,data.from,lIdx); render(); }});
        addDragVisuals(title);
        layerDiv.appendChild(title);

        /* TASKS area */
        const row=document.createElement('div'); row.className='tasks-row';
        row.addEventListener('dragover',e=>{ e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect='move'; });
        row.addEventListener('drop',e=>{
          e.preventDefault(); e.stopPropagation();
          const data=getDndData(e);
          if(data&&data.type==='task'){
            if(data.layer!==lIdx && layers[data.layer].tasks.length<=1) return; // keep >= 1 per layer
            const moved=layers[data.layer].tasks.splice(data.from,1)[0];
            layers[lIdx].tasks.push(moved); render();
          }
        });
        addDragVisuals(row);

        layer.tasks.forEach((task,tIdx)=>row.appendChild(makeTaskTable(layer,lIdx,task,tIdx)));
        layerDiv.appendChild(row);

        const ctrl=document.createElement('div'); ctrl.className='task-controls';
        const addBtn=document.createElement('button'); addBtn.textContent='+'; addBtn.onclick=()=>{ addTask(lIdx); };
        ctrl.appendChild(addBtn);

        layerDiv.appendChild(ctrl);
        layersContainer.appendChild(layerDiv);
      });

      document.getElementById('removeLayerBtn').disabled = layers.length <= 2;

      updatePathBuilderUI();
      applySelectedTaskHighlights();  // blue (input tables)
      applyPathRiskHighlights();      // risk colors (path tables)
      handleChange();
    }

    function makeTaskTable(layer,lIdx,task,tIdx){
      const tbl=document.createElement('table'); tbl.className='task-table';
      const multi=layer.tasks.length>1; const taskId=multi?`${lIdx+1}.${tIdx+1}`:`${lIdx+1}`; tbl.dataset.taskId=taskId;

      /* Accept drops ON a task to insert before it */
      tbl.addEventListener('dragover',e=>{ e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect='move'; });
      tbl.addEventListener('drop',e=>{
        e.preventDefault(); e.stopPropagation();
        const data=getDndData(e); if(!data||data.type!=='task') return;
        if(data.layer!==lIdx && layers[data.layer].tasks.length<=1) return;
        const moved=layers[data.layer].tasks.splice(data.from,1)[0];
        let toIdx=tIdx; if(data.layer===lIdx && data.from<tIdx) toIdx-=1;
        layers[lIdx].tasks.splice(toIdx,0,moved); render();
      });
      addDragVisuals(tbl);

      const thead=document.createElement('thead');

      /* Header row with dedicated drag handle + description + buttons */
      const tr1=document.createElement('tr');
      const th1=document.createElement('th'); th1.colSpan=4; th1.className='task-handle';

      const header=document.createElement('div'); header.className='task-header-container';

      /* TASK drag handle (⠿) */
      const handle=document.createElement('span'); handle.className='drag-handle'; handle.textContent='⠿'; handle.title='Drag task';
      handle.draggable=true;
      handle.addEventListener('dragstart',e=>{ e.stopPropagation(); e.dataTransfer.effectAllowed='move';
        e.dataTransfer.setData('application/json',JSON.stringify({type:'task',layer:lIdx,from:tIdx})); tbl.classList.add('dragging'); });
      handle.addEventListener('dragend',e=>{ e.stopPropagation(); tbl.classList.remove('dragging'); });

      const labelSpan=document.createElement('span');
      const n=layer.tasks.length>1?`.${tIdx+1}`:''; labelSpan.textContent=`Task ${lIdx+1}${n} - `;
      labelSpan.style.fontWeight='700'; labelSpan.style.fontSize='16px';

      const desc=document.createElement('input'); desc.type='text'; desc.placeholder='Description'; desc.value=task.desc;
      desc.onchange=e=>{ task.desc=e.target.value; handleChange(); };

      const right=document.createElement('div'); right.className='task-header-right';
      const addToPathBtn=document.createElement('button'); addToPathBtn.textContent='add to path'; addToPathBtn.onclick=()=>{ selectTaskInPath(lIdx,taskId); };
      const removeBtn=document.createElement('button'); removeBtn.textContent='remove'; removeBtn.onclick=()=>{ removeTaskAt(lIdx,tIdx); };

      right.appendChild(addToPathBtn); right.appendChild(removeBtn);
      header.appendChild(handle); header.appendChild(labelSpan); header.appendChild(desc); header.appendChild(right);
      th1.appendChild(header); tr1.appendChild(th1); thead.appendChild(tr1);

      /* Main Headings */
      const tr2=document.createElement('tr');
      ['P(Detection)','Location','Delay Mean (s)','Delay Standard Deviation (s)']
        .forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr2.appendChild(th); });
      thead.appendChild(tr2);
      tbl.appendChild(thead);

      const tbody=document.createElement('tbody');
      const trB=document.createElement('tr');

      const tdPD=document.createElement('td'); tdPD.innerHTML=`<input type="number" min="0" max="1" step="0.01">`;
      tdPD.firstChild.value=task.pDetection; tdPD.firstChild.onchange=e=>{ task.pDetection=e.target.value; handleChange(); }; trB.appendChild(tdPD);

      const tdLoc=document.createElement('td'); tdLoc.innerHTML=`<select><option value="B">B</option><option value="M">M</option><option value="E">E</option></select>`;
      const sel=tdLoc.firstElementChild; sel.value=task.location; sel.oninput=sel.onchange=e=>{ task.location=e.target.value; handleChange(); }; trB.appendChild(tdLoc);

      const tdMean=document.createElement('td'); tdMean.innerHTML=`<input type="number" min="0" step="1">`;
      tdMean.firstChild.value=task.mean; tdMean.firstChild.onchange=e=>{ task.mean=e.target.value; handleChange(); }; trB.appendChild(tdMean);

      const tdSdev=document.createElement('td'); tdSdev.innerHTML=`<input type="number" min="0" step="0.1">`;
      tdSdev.firstChild.value=task.sdev; tdSdev.firstChild.onchange=e=>{ task.sdev=e.target.value; handleChange(); }; trB.appendChild(tdSdev);

      tbody.appendChild(trB); tbl.appendChild(tbody);
      return tbl;
    }

    /* controls */
    function addLayer(){ layers.push(makeLayer()); render(); }
    function removeLayer(){ if(layers.length>2){ layers.pop(); render(); } }
    function addTask(layerIndex){ layers[layerIndex].tasks.push(makeTask()); render(); }
    function removeTaskAt(layerIndex,taskIndex){
      const layer=layers[layerIndex]; if(!layer) return; if(layer.tasks.length<=1) return;
      const multi=layer.tasks.length>1; const doomedId=multi?`${layerIndex+1}.${taskIndex+1}`:`${layerIndex+1}`;
      if(pathSelection[layerIndex]===doomedId) pathSelection[layerIndex]='';
      layer.tasks.splice(taskIndex,1); render();
    }
    function selectTaskInPath(layerIndex,taskId){
      pathSelection=Array.from({length:Math.max(pathSelection.length,layerIndex+1)},(_,i)=>pathSelection[i]||'');
      pathSelection[layerIndex]=taskId; updatePathBuilderUI(); computeAndRenderUserPathPI();
      applySelectedTaskHighlights(); applyPathRiskHighlights();
    }

    function handleChange(){
      if (typeof Handle_Change === 'function') Handle_Change();  /* provided by EASI.js */
      updatePathBuilderUI();
      computeAndRenderUserPathPI();
      applySelectedTaskHighlights();
      applyPathRiskHighlights();
    }

    function init(){ layers=[makeLayer(),makeLayer()]; render(); }

    /* Path Selector */
    let pathSelection=[];

    function pathLayersSnapshot(){
      return layers.map((layer,lIdx)=>{
        const multi=layer.tasks.length>1;
        return layer.tasks.map((t,tIdx)=>{
          const id=multi?`${lIdx+1}.${tIdx+1}`:`${lIdx+1}`;
          return { Task_ID:id, Task_Description:t.desc||'', PD:t.pDetection, location:t.location, mean:t.mean, sdev:t.sdev };
        });
      });
    }

    function getMVPTaskIDsFromUI(){
      const raw=(document.getElementById('MVPpath')?.textContent||'').trim();
      if(!raw) return [];
      return Array.from(raw.matchAll(/\d+(?:\.\d+)?/g)).map(m=>m[0]);
    }

    function updatePathBuilderUI(){
      const layerTasks=pathLayersSnapshot();
      const wrap=document.getElementById('pathBuilderWrap'); if(!wrap) return;
      wrap.innerHTML='';
      pathSelection=Array.from({length:layerTasks.length},(_,i)=>pathSelection[i]||'');

      layerTasks.forEach((tasks,layerIdx)=>{
        const row=document.createElement('div'); row.className='path-row';
        const heading=document.createElement('div'); heading.className='path-layer-heading'; heading.textContent=`Layer ${layerIdx+1}:`; row.appendChild(heading);

        const select=document.createElement('select'); select.dataset.layerIndex=String(layerIdx);
        const emptyOpt=document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='---'; select.appendChild(emptyOpt);
        tasks.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.Task_ID; const d=(t.Task_Description||'').trim(); opt.textContent=`- Task ${t.Task_ID} - ${d}`; select.appendChild(opt); });

        select.value=pathSelection[layerIdx]||'';
        select.onchange=e=>{ pathSelection[layerIdx]=e.target.value||''; handleChange(); };
        row.appendChild(select);

        const holder=document.createElement('div'); holder.id=`pathTableHolder_${layerIdx}`;
        wrap.appendChild(row); wrap.appendChild(holder);

        renderOneLayerTable(layerIdx, tasks, pathSelection[layerIdx]);
      });

      const clearBtn=document.getElementById('clearPathBtn');
      if(clearBtn) clearBtn.onclick=()=>{ pathSelection=pathSelection.map(()=> ''); updatePathBuilderUI(); computeAndRenderUserPathPI(); applySelectedTaskHighlights(); applyPathRiskHighlights(); };

      const useMVPBtn=document.getElementById('useMVPBtn');
      if(useMVPBtn) useMVPBtn.onclick=()=>{ const ids=getMVPTaskIDsFromUI(); if(ids.length){ const n=Math.min(ids.length,pathSelection.length); for(let i=0;i<n;i++) pathSelection[i]=ids[i]; updatePathBuilderUI(); computeAndRenderUserPathPI(); applySelectedTaskHighlights(); applyPathRiskHighlights(); } };

      const toggleHLBtn=document.getElementById('toggleHLBtn');
      if(toggleHLBtn) toggleHLBtn.onclick=()=>{ highlightEnabled=!highlightEnabled; applySelectedTaskHighlights(); applyPathRiskHighlights(); };
    }

    /* Read-only table renderer */
    let lastEval=null;

    function renderOneLayerTable(layerIdx, tasks, selectedID){
      const holder=document.getElementById(`pathTableHolder_${layerIdx}`); if(!holder) return;
      holder.innerHTML=''; if(!selectedID) return;

      const task=(tasks||[]).find(t=>t.Task_ID===selectedID); if(!task) return;

      const tbl=document.createElement('table'); tbl.className='task-table-ro';
      tbl.dataset.taskId = task.Task_ID;

      const thead=document.createElement('thead');
      const trH=document.createElement('tr'); const thH=document.createElement('th'); thH.colSpan=5;
      const label=document.createElement('span');
      label.textContent=`Task ${task.Task_ID} - ${task.Task_Description||''}`;
      label.style.fontWeight='700'; label.style.fontSize='16px';
      thH.appendChild(label); trH.appendChild(thH); thead.appendChild(trH);
      tbl.appendChild(thead);

      const tbody=document.createElement('tbody');

      /* Pull computed step (if available) */
      let step=null;
      if (lastEval && Array.isArray(lastEval.PerStep)) {
        step = lastEval.PerStep.find(s => (s.Task_ID===task.Task_ID) || (s.ID===task.Task_ID));
      }

      /* Row group 1 */
      const tr1h=document.createElement('tr');
      ['P(Detection)','Location','Delay Mean (s)','Delay Standard Deviation (s)','Adjusted P(d)']
        .forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr1h.appendChild(th); });
      tbody.appendChild(tr1h);

      const adjustedPd = step ? pick(step, ['AdjustedPd','AdjustedPD','Adjusted_Pd','AdjustedDetection','AdjPd']) : '';
      const tr1v=document.createElement('tr');
      [task.PD, task.location, task.mean, task.sdev, adjustedPd]
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=fmtNum(v); tr1v.appendChild(td); });
      tbody.appendChild(tr1v);

      /* Row group 2 */
      const tr2h=document.createElement('tr');
      ['Missed Detection','First Detection','Cumulative Delay','Cumulative Variation','True Mean']
        .forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr2h.appendChild(th); });
      tbody.appendChild(tr2h);

      let missed = step ? pick(step, ['MissedDetection','MissDetection','Missed_Detection']) : '';
      if (missed==='' && adjustedPd !== '' && Number.isFinite(Number(adjustedPd))) missed = 1 - Number(adjustedPd);
      const firstDet  = step ? pick(step, ['FirstDetection','FirstDetect']) : '';
      const cumDelay  = step ? pick(step, ['CumulativeDelay','CumDelay','Cumulative_Delay']) : '';
      const cumVar    = step ? pick(step, ['CumulativeVariation','CumVar','Cumulative_Variation']) : '';
      const trueMean  = step ? pick(step, ['TrueMean','True_Mean']) : '';
      const tr2v=document.createElement('tr');
      [missed, firstDet, cumDelay, cumVar, trueMean]
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=fmtNum(v); tr2v.appendChild(td); });
      tbody.appendChild(tr2v);

      /* Row group 3 */
      const tr3h=document.createElement('tr');
      ['True Variation','Z-Value','Normal Value'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr3h.appendChild(th); });
      const thTip=document.createElement('th'); thTip.textContent='Task Interruption Probability'; thTip.colSpan=2; tr3h.appendChild(thTip);
      tbody.appendChild(tr3h);

      const trueVar = step ? pick(step, ['TrueVariation','TrueVar','True_Variation']) : '';
      const zval    = step ? pick(step, ['ZValue','Z_Value','Z']) : '';
      const normalV = step ? pick(step, ['NormalValue','Normal_Value','Normal','Phi']) : '';
      let tip       = step ? pick(step, ['TaskProbabilityOfInterruption','TIP','Task_PI']) : '';

      const tr3v=document.createElement('tr');
      [trueVar, zval, normalV].forEach(v=>{ const td=document.createElement('td'); td.textContent=fmtNum(v); tr3v.appendChild(td); });

      const tipTd=document.createElement('td'); tipTd.colSpan=2;
      if (lastEval && step && tip !== '') {
        const pct = Number(tip) * 100;
        tipTd.textContent = Number.isFinite(pct) ? `${pct.toFixed(6)}%` : '';
      } else {
        tipTd.textContent = 'full path required';
      }
      tr3v.appendChild(tipTd);
      tbody.appendChild(tr3v);

      tbl.appendChild(tbody);
      holder.appendChild(tbl);

      applyRiskToOnePathTable(tbl);
    }

    /* overall user path */
    function computeAndRenderUserPathPI(){
      const piEl=document.getElementById('userPathPI'); if(!piEl) return;

      if (typeof Compute_Selected_Path_Info !== 'function') {
        piEl.textContent='Probability of Interruption: full path required';
        return;
      }
      const res=Compute_Selected_Path_Info(pathSelection);
      lastEval = (res && res.complete) ? res : null;

      if (res && res.complete) {
        const pct = Number(res.OverallProbabilityOfInterruption)*100;
        piEl.textContent = `Probability of Interruption: ${isFinite(pct)?pct.toFixed(6):''}%`;
      } else {
        piEl.textContent='Probability of Interruption: full path required';
      }

      const layerTasks=pathLayersSnapshot();
      layerTasks.forEach((tasks,idx)=>renderOneLayerTable(idx,tasks,pathSelection[idx]));
      applyPathRiskHighlights();
    }

    /* highlights */
    let highlightEnabled=false;
    function applySelectedTaskHighlights(){
      const allTables=Array.from(document.querySelectorAll('#layersContainer .task-table'));
      allTables.forEach(tbl=>tbl.classList.remove('path-highlight'));
      if(!highlightEnabled) return;
      const selectedSet=new Set(pathSelection.filter(Boolean));
      allTables.forEach(tbl=>{ const id=tbl.dataset.taskId; if(id && selectedSet.has(id)) tbl.classList.add('path-highlight'); });
    }

    /* risk highlighting (path tables) */
    function getStepByTaskId(taskId){
      if(!lastEval || !Array.isArray(lastEval.PerStep)) return null;
      return lastEval.PerStep.find(s => (s.Task_ID === taskId) || (s.ID === taskId));
     }
    function getTIPFromStep(step){
      if(!step) return null;
      const v = pick(step, ['TaskProbabilityOfInterruption','TIP','Task_PI','TaskPI','Task_Interruption_Probability']);
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function applyRiskToOnePathTable(tbl){
      if(!tbl) return;
      tbl.classList.remove('risk-low','risk-med','risk-high');
      if(!highlightEnabled) return;

      const step = getStepByTaskId(tbl.dataset.taskId);
      const tip  = getTIPFromStep(step);
      if(tip === null) return;

      const pct = tip * 100;
      if(pct > 0 && pct < 10) tbl.classList.add('risk-low');
      else if(pct >= 10 && pct < 50) tbl.classList.add('risk-med');
      else if(pct >= 50) tbl.classList.add('risk-high');
    }
    function applyPathRiskHighlights(){
      Array.from(document.querySelectorAll('.task-table-ro')).forEach(applyRiskToOnePathTable);
    }

    /* boot */
    init();
  </script>

</body>
</html>
