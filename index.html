<!DOCTYPE html>
<html lang="en">
<!-- EASI.js REFERENCE -->
<script src="EASI.js"></script>

<head>
  <meta charset="utf-8" />
  <title>EASI Web App</title>

  <style>
    /* Base table look */
    table {
      border-collapse: collapse;
    }

    th,
    td {
      padding: 6px;
      border: 1px solid black;
    }

    .invis {
      border: none;
    }

    /* Layer / Task Layout */
    .layers-wrap {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }

    .layer {
      display: flex;
      align-items: stretch;
      gap: 10px;
      border: 1px solid black;
      padding: 6px;
    }

    .layer-title {
      min-width: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid black;
      padding: 6px;
      font-weight: 600;
      background: #efefef;
    }

    /* Vertical Task Stack (use to be in a row) */
    .tasks-row {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }

    .task-table,
    .transition-table {
      display: table;
      width: auto;
      table-layout: fixed;
    }

    .task-table th,
    .task-table td,
    .transition-table th,
    .transition-table td {
      padding: 6px;
      border: 1px solid black;
      text-align: left;
    }

    .task-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      justify-content: center;
    }

    .controls-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    button {
      cursor: pointer;
    }

    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>

  <p style="text-align:center; border:none; font-size:25px;">
    Estimate of Adversary Sequence Interruption
  </p>
</head>

<body>

  <!-- Universal Table -->
  <table>
    <thead>
      <th>Probability of Guard Communication:</th>
      <th>P(Assessment):</th>
      <th>P(Transmission):</th>
      <th>Response Mean:</th>
      <th>Force Time (in Seconds) Standard Deviation:</th>
    </thead>

    <tbody id="smallTable">
      <td><input type="number" placeholder="????" min="0" max="1" step="0.01" onchange="handleChange()"></td>
      <td><input type="number" placeholder="????" min="0" max="1" step="0.01" onchange="handleChange()"></td>
      <td><input type="number" placeholder="????" min="0" max="1" step="0.01" onchange="handleChange()"></td>
      <td><input type="number" placeholder="????" min="0" step="1" onchange="handleChange()"></td>
      <td><input type="number" placeholder="????" min="0" step="0.1" onchange="handleChange()"></td>
    </tbody>
  </table>

  <!-- Spacer -->
  <table>
    <tbody>
      <td class="invis"></td>
    </tbody>
  </table>

  <!-- LAYERS Area -->
  <div id="layersContainer" class="layers-wrap"></div>

  <!-- Global Unit controls -->
  <div class="controls-row">
    <button id="addUnitBtn" onclick="addUnit()">+ pair</button>
    <button id="removeUnitBtn" onclick="removeUnit()">− pair</button>
  </div>

  <br>

  <!-- Result Section -->
  <table>
    <tbody>
      <tr>
        <th>Most Vulnerable Path:</th>
        <th id="MVPpath"></th>
      </tr>
      <tr>
        <th>Probability of Interruption:</th>
        <th id="EASIresult"></th>
      </tr>
    </tbody>
  </table>

  <pre id="PathList" style="font-size:14px;"></pre>
  <pre id="MVPList" style="font-size:14px;"></pre>

  <pre id="output"></pre>

  <script>
    /* ================================================
       UNIT MODEL:
       - Each UNIT is a pair of LAYERS:
         - The first is a transitional space.
         - The second is a set of possible tasks.

       - There is always a minimum of TWO UNITS:
         - FIRST UNIT:
           - Off-site Layer
           - First Task Layer
         - LAST UNIT:
           - Vital Area Layer
           - Target Layer [Limited to 1 task]

       - New units are inserted BEFORE the last unit.
       ================================================*/

    const layersContainer = document.getElementById('layersContainer');

    /* Task 'Template' */
    function makeTask(desc = '') {
      return { desc, pDetection: '', location: 'B', mean: '', sdev: '' };
    }

    /** Unit 'Template' */
    function makeUnit(transitionName = '') {
      return {
        transition: { name: transitionName, pDetection: '', location: 'B', mean: '', sdev: '' },
        tasksLayer: { tasks: [makeTask()] },   // at least one task table
        isFinal: false
      };
    }

    /** Final unit (Vital Area + Target) */
    function makeFinalUnit() {
      return {
        transition: { name: 'Vital Area', pDetection: '', location: 'B', mean: '', sdev: '' },
        tasksLayer: { tasks: [makeTask('Target')] }, // locked to 1 task
        isFinal: true
      };
    }

    let units = [];

    /* RENDER LAYERS */
    function render() {
      layersContainer.innerHTML = '';

      // Build layers in order
      units.forEach((unit, uIdx) => {
        const layerNumberTrans = uIdx * 2 + 1; // transitional
        const layerNumberTasks = uIdx * 2 + 2; // task group

        // Transitional layer
        const transDiv = document.createElement('div');
        transDiv.className = 'layer';

        const transTitle = document.createElement('div');
        transTitle.className = 'layer-title';
        transTitle.textContent = `Layer ${layerNumberTrans}`;
        transDiv.appendChild(transTitle);

        // Table
        transDiv.appendChild(makeTransitionTable(unit, uIdx, layerNumberTrans));
        layersContainer.appendChild(transDiv);

        // Tasks layer
        const taskDiv = document.createElement('div');
        taskDiv.className = 'layer';

        const taskTitle = document.createElement('div');
        taskTitle.className = 'layer-title';
        taskTitle.textContent = `Layer ${layerNumberTasks}`;
        taskDiv.appendChild(taskTitle);

        const row = document.createElement('div');
        row.className = 'tasks-row';

        unit.tasksLayer.tasks.forEach((task, tIdx) => {
          row.appendChild(makeTaskTable(unit, uIdx, task, tIdx, unit.isFinal));
        });

        taskDiv.appendChild(row);

        // Task controls
        const ctrl = document.createElement('div');
        ctrl.className = 'task-controls';

        const addBtn = document.createElement('button');
        addBtn.textContent = '+';
        addBtn.disabled = unit.isFinal === true;
        addBtn.onclick = () => { addTaskToUnit(uIdx); };

        const remBtn = document.createElement('button');
        remBtn.textContent = '−';
        remBtn.disabled = unit.isFinal === true || unit.tasksLayer.tasks.length <= 1;
        remBtn.onclick = () => { removeTaskFromUnit(uIdx); };

        ctrl.appendChild(addBtn);
        ctrl.appendChild(remBtn);

        taskDiv.appendChild(ctrl);
        layersContainer.appendChild(taskDiv);
      });

      // Remove pair (UNIT) button with minimum of 2
      document.getElementById('removeUnitBtn').disabled = units.length <= 2;

      handleChange();
    }

    /* Transitional layer table */
    function makeTransitionTable(unit, uIdx, layerNumberTrans) {
      const tbl = document.createElement('table');
      tbl.className = 'transition-table';

      const thead = document.createElement('thead');

      // Header
      const tr1 = document.createElement('tr');
      const th1 = document.createElement('th');
      th1.colSpan = 4;

      const labelSpan = document.createElement('span');
      labelSpan.textContent = `Task ${layerNumberTrans} - `;
      labelSpan.style.fontWeight = '600';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = (uIdx === 0) ? 'Off-site Area' : (unit.isFinal ? 'Vital Area' : 'Layer name');
      nameInput.value = unit.transition.name;
      nameInput.onchange = (e) => { unit.transition.name = e.target.value; handleChange(); };

      th1.appendChild(labelSpan);
      th1.appendChild(nameInput);
      tr1.appendChild(th1);
      thead.appendChild(tr1);

      // Subheadings
      const tr2 = document.createElement('tr');
      ['P(Detection)', 'Location', 'Delay Mean (s)', 'Delay Standard Deviation (s)']
        .forEach(label => {
          const th = document.createElement('th');
          th.textContent = label;
          tr2.appendChild(th);
        });
      thead.appendChild(tr2);
      tbl.appendChild(thead);

      // Input Row
      const tbody = document.createElement('tbody');
      const trB = document.createElement('tr');

      // P(Detection)
      const tdPDetection = document.createElement('td');
      tdPDetection.innerHTML = `<input type="number" placeholder="????" min="0" max="1" step="0.01">`;
      tdPDetection.firstChild.value = unit.transition.pDetection;
      tdPDetection.firstChild.onchange = (e) => { unit.transition.pDetection = e.target.value; handleChange(); };
      trB.appendChild(tdPDetection);

      // Location
      const tdLocation = document.createElement('td');
      tdLocation.innerHTML = `
        <select>
          <option value="B">B</option>
          <option value="M">M</option>
          <option value="E">E</option>
        </select>`;
      const selT = tdLocation.firstElementChild;
      selT.value = unit.transition.location;
      selT.oninput = (e) => { unit.transition.location = e.target.value; handleChange(); };
      selT.onchange = (e) => { unit.transition.location = e.target.value; handleChange(); };
      trB.appendChild(tdLocation);

      // Delay mean
      const tdMean = document.createElement('td');
      tdMean.innerHTML = `<input type="number" placeholder="????" min="0" step="1">`;
      tdMean.firstChild.value = unit.transition.mean;
      tdMean.firstChild.onchange = (e) => { unit.transition.mean = e.target.value; handleChange(); };
      trB.appendChild(tdMean);

      // Delay SDev
      const tdSDev = document.createElement('td');
      tdSDev.innerHTML = `<input type="number" placeholder="????" min="0" step="0.1">`;
      tdSDev.firstChild.value = unit.transition.sdev;
      tdSDev.firstChild.onchange = (e) => { unit.transition.sdev = e.target.value; handleChange(); };
      trB.appendChild(tdSDev);

      tbody.appendChild(trB);
      tbl.appendChild(tbody);

      return tbl;
    }

    function makeTaskTable(unit, uIdx, task, tIdx, isFinal) {
      const tbl = document.createElement('table');
      tbl.className = 'task-table';

      const layerNumberTasks = uIdx * 2 + 2;
      const taskNumber = tIdx + 1;

      // Header
      const thead = document.createElement('thead');
      const tr1 = document.createElement('tr');
      const th1 = document.createElement('th');
      th1.colSpan = 4;

      const labelSpan = document.createElement('span');
      labelSpan.textContent = `Task ${layerNumberTasks}.${taskNumber} - `;
      labelSpan.style.fontWeight = '600';

      const desc = document.createElement('input');
      desc.type = 'text';
      desc.placeholder = (isFinal && tIdx === 0) ? 'TARGET' : 'Description';
      desc.value = task.desc;
      desc.onchange = (e) => { task.desc = e.target.value; handleChange(); };

      th1.appendChild(labelSpan);
      th1.appendChild(desc);
      tr1.appendChild(th1);
      thead.appendChild(tr1);

      // Subheadings
      const tr2 = document.createElement('tr');
      ['P(Detection)', 'Location', 'Delay Mean (s)', 'Delay Standard Deviation (s)']
        .forEach(label => {
          const th = document.createElement('th');
          th.textContent = label;
          tr2.appendChild(th);
        });
      thead.appendChild(tr2);
      tbl.appendChild(thead);

      // Input row
      const tbody = document.createElement('tbody');
      const trB = document.createElement('tr');

      // P(Detection)
      const tdPDetection = document.createElement('td');
      tdPDetection.innerHTML = `<input type="number" placeholder="????" min="0" max="1" step="0.01">`;
      tdPDetection.firstChild.value = task.pDetection;
      tdPDetection.firstChild.onchange = (e) => { task.pDetection = e.target.value; handleChange(); };
      trB.appendChild(tdPDetection);

      // Location
      const tdLocation = document.createElement('td');
      tdLocation.innerHTML = `
        <select>
          <option value="B">B</option>
          <option value="M">M</option>
          <option value="E">E</option>
        </select>`;
      const sel = tdLocation.firstElementChild;
      sel.value = task.location;
      sel.oninput = (e) => { task.location = e.target.value; handleChange(); };
      sel.onchange = (e) => { task.location = e.target.value; handleChange(); };
      trB.appendChild(tdLocation);

      // Delay mean
      const tdMean = document.createElement('td');
      tdMean.innerHTML = `<input type="number" placeholder="????" min="0" step="1">`;
      tdMean.firstChild.value = task.mean;
      tdMean.firstChild.onchange = (e) => { task.mean = e.target.value; handleChange(); };
      trB.appendChild(tdMean);

      // Delay SDev
      const tdSDev = document.createElement('td');
      tdSDev.innerHTML = `<input type="number" placeholder="????" min="0" step="0.1">`;
      tdSDev.firstChild.value = task.sdev;
      tdSDev.firstChild.onchange = (e) => { task.sdev = e.target.value; handleChange(); };
      trB.appendChild(tdSDev);

      tbody.appendChild(trB);
      tbl.appendChild(tbody);

      return tbl;
    }

    /* ===============
       UNIT Controls
       ===============*/
    function addUnit() {
      // Insert before final unit
      const idx = Math.max(0, units.length - 1);
      units.splice(idx, 0, makeUnit(''));
      render();
    }

    function removeUnit() {
      if (units.length <= 2) return; // min units of 2
      // Remove unit preceeding final unit
      units.splice(units.length - 2, 1);
      render();
    }

    /* ===============
       Layer Controls
       ===============*/
    function addTaskToUnit(uIdx) {
      const unit = units[uIdx];
      if (unit.isFinal) return;
      unit.tasksLayer.tasks.push(makeTask());
      render();
    }

    function removeTaskFromUnit(uIdx) {
      const unit = units[uIdx];
      if (unit.isFinal) return;
      if (unit.tasksLayer.tasks.length > 1) {
        unit.tasksLayer.tasks.pop();
        render();
      }
    }

    /* Result */
    function handleChange() {

      const EASIcontent = CalculateMVP() || {};
      // pathText          ->  List of all paths and respective probabilities of interruption.
      // mvpDetailsText    ->  List of all tasks in the MVP and their backend values (Used for testing).
      // mvpPInterruption  ->  Probability of interruption of the MVP.
      // mvpPath           ->  Path taken for the MVP.

      const MVPpath = String(EASIcontent.mvpPath || "");
      document.getElementById("MVPpath").textContent = MVPpath;

      const ProbabilityOfInterruption = Number(EASIcontent.mvpPInterruption);
      document.getElementById("EASIresult").textContent =
        Number.isFinite(ProbabilityOfInterruption)
          ? `${ProbabilityOfInterruption.toFixed(6)} %`
          : "";

      // Can print every path and P(i):
      // const PathList = String(EASIcontent.pathText || "");
      // document.getElementById("PathList").textContent = PathList;

      // Can print every task of the MVP:
      // const MVPList = String(EASIcontent.mvpDetailsText || "");
      // document.getElementById("MVPList").textContent = MVPList;
    }

    /* make the 2 mandatory units */
    function init() {

      // First Unit
      const u0 = makeUnit('Off-site Area');

      // Last Unit
      const uF = makeFinalUnit();

      units = [u0, uF];
      render();
    }

    init();

  </script>

</body>

</html>